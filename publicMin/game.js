function makeNewPopperGame(t,e,r){function a(t,e,r){var a;return p.length>0?(a=p.pop(),a.t.forEachSet(function(){return 0}),a.x=t,a.y=e,a.h=r):a={x:t,y:e,t:new binaryData.Array(d,8,!1),h:r,v:0},r>d&&(console.log(a),alert(r)),m[t].push(a),a}function i(t){p.push(t)}function n(){for(;D>x[y+1]&&y<x.length-1;)switch(y++,y){case 1:I=!1;break;case 2:for(var t=0;g>t;t++){var e=a(t,-r,1);e.t.set(0,6)}for(var t=0;20*g>t;t++){var i=Math.random()*g*r;c.makeParticle(i,0,100*Math.random()+10,100*Math.random()+10,1e3*Math.random()+1e3,50,"white",5,0)}break;case 3:I=!0,M=2,s();break;case 4:M=3;break;case 5:M=4;break;case 6:M=5;break;case 7:M=6;break;case 8:I=!1;break;case 9:for(var t=0;g>t;t++){var e=a(t,-r,1);e.t.set(0,h())}break;case 10:M=1;for(var t=0;g>t;t++)for(var e=a(t,-3*r,3),n=0;3>n;n++)e.t.set(n,h());break;case 11:I=!0;break;case 12:alert("you have won the game at it's current state!")}}function h(){function t(){return 1==M?rand(4)+2:2==M?[2,4,5,6][rand(4)]:3==M?[2,4,4,4,4,5,6,6,6,6,6,6][rand(12)]:4==M?[2,4,4,4,4,4,6,6,6,6,6,6][rand(12)]:5==M?[2,2,2,4,5,4,3,5,6,4,6,6][rand(12)]:6==M?[2,3,4,5,6][rand(5)]:7==M?[2,3,4,5,6][rand(5)]:void 0}var e=t();return Math.random()<.95?e:2==e?16:3==e?17:e}function o(){k.forEach(function(t,e){if(t)for(var i=0,n=0,o=0;d>o;o++)if(u.get(e,o))n++;else if(n||!i&&I){for(var s=!i&&I?t:0,f=a(e,(o-n-s)*r,n+s),l=0;s>l;l++)f.t.set(l,h());for(var l=0;n>l;l++)f.t.set(l+s,u.get(e,o-n+l)),u.set(e,o-n+l,0);i++}})}function s(){k.setAll(0),u.forEach(function(t,e){0==t&&k.set(e,k.get(e)+1)}),m.forEach(function(t,e){t.forEach(function(t){k.set(e,Math.max(0,k.get(e)-t.h))})}),o()}function f(t,e){return t>=powerIndex&&(t=t-powerIndex+baseIndex),e>=powerIndex&&(e=e-powerIndex+baseIndex),t==e}var l={grid:new binaryData.Grid(t,e,8,!1),size:r,width:t,height:e,chains:[],overlays:[]},c=createParticleSystem();l.pS=c;var u=l.grid,g=t,d=e;console.log(u);for(var m=l.chains,b=0;g>b;b++)m.push([]);var p=[],M=1,y=0,w=[],x=w;x[1]=150,x[2]=x[1]+Math.floor(.4*g*d),x[3]=x[2]+Math.floor(.4*g*d)+g,x[4]=x[3]+Math.floor(.2*g*d),x[5]=x[4]+200,x[6]=x[5]+200,x[7]=x[6]+150,x[8]=x[7]+100,x[9]=x[8]+Math.floor(.3*g*d),x[10]=x[9]+Math.floor(.3*g*d),x[11]=x[10]+3*g,x[12]=x[11]+300;var I=!0,D=0;l.chains=m;var A=new binaryData.Grid(t,e,8,!1),k=new binaryData.Array(t,16,!1);return l.modifiedClumns=k,l.fill=s,setInterval(function(){I&&s()},1e3),l.grid.forEachSet(function(){return h()}),l.grid.set(5,5,16),l.grid.set(12,10,17),l.draw=function(){var t=this.size;this.grid.forEach(function(e,r,a){e>1&&ctx.drawImage(tiles[e],r*t*ratio,a*t*ratio,t*ratio,t*ratio)}),m.forEach(function(e){e.forEach(function(e){e.t.forEach(function(r,a){r>1&&ctx.drawImage(tiles[r],e.x*t*ratio,(a*t+e.y)*ratio)})})}),ctx.save(),ctx.scale(ratio,ratio),this.overlays.forEach(function(t){t.draw(ctx)}),c.draw(ctx),ctx.restore()},l.update=function(t){m.forEach(function(e){for(var a=0;a<e.length;a++){var n=e[a];n.v=Math.min(.5*r,n.v+.03125*r*t),n.y+=Math.min(.03125*n.v*t,.5*r),(u.get(n.x,Math.floor((n.y+n.h*r)/r))||n.y+n.h*r>=d*r)&&(n.t.forEach(function(t,e){t&&u.set(n.x,e+Math.floor(n.y/r),t)}),i(n),e.splice(a,1),a--)}});for(var e=0;e<this.overlays.length;e++)this.overlays[e].update(t)&&(this.overlays.splice(e,1),e--);c.update(t)},l.specialQueue=[],l.burst=function(t,e,a){var i=u.get(t,e);i>=powerIndex?this.specialQueue.push({x:t,y:e,f:i-powerIndex}):a&&i>1&&l.pS.burst(t*r,e*r,40,r,2e3,particleColors[i]),i>1&&D++,u.set(t,e,0)},l.click=function(t,e){if(t=Math.floor(t/r),e=Math.floor(e/r),g>t&&d>e){var a=u.get(t,e),i=0;if(A.setAll(0),a>=baseIndex){for(propagate(u,t,e,function(t){return f(t,a)},function(r,a){i++,2==i&&l.burst(t,e,!0),i>=2&&l.burst(r,a,!0)},A);this.specialQueue.length;)v=this.specialQueue.shift(),specials[v.f](l,v.x,v.y);s()}}n()},l.usedChains=p,l.chains=m,l}