function makeNewPopperGame(t,e,a){function i(t,e,a){var i;return m.length>0?(i=m.pop(),i.t.forEachSet(function(){return 0}),i.x=t,i.y=e,i.h=a):i={x:t,y:e,t:new binaryData.Array(g,8,!1),h:a,v:0},u[t].push(i),i}function r(t){m.push(t)}function n(){for(;w>y[M+1]&&M<y.length-1;)switch(M++,M){case 1:p=!1;break;case 2:for(var t=0;l>t;t++){var e=i(t,-a,1);e.t.set(0,6)}break;case 3:p=!0,d=2,s();break;case 4:d=3;break;case 5:d=4;break;case 6:d=5;break;case 7:d=6;break;case 8:p=!1;break;case 9:for(var t=0;l>t;t++){var e=i(t,-a,1);e.t.set(0,h())}break;case 10:d=1;for(var t=0;l>t;t++)for(var e=i(t,-a,1),r=0;3>r;r++)e.t.set(r,h());break;case 11:p=!0;break;case 12:alert("you have won the game at it's current state!")}}function h(){return 1==d?rand(4)+2:2==d?[2,4,5,6][rand(4)]:3==d?[2,4,4,4,4,5,6,6,6,6,6,6][rand(12)]:4==d?[2,4,4,4,4,4,6,6,6,6,6,6][rand(12)]:5==d?[2,2,2,4,5,4,3,5,6,4,6,6][rand(12)]:6==d?[2,3,4,5,6][rand(5)]:7==d?[2,3,4,5,6][rand(5)]:void 0}function o(){A.forEach(function(t,e){if(t)for(var r=0,n=0,o=0;g>o;o++)if(c.get(e,o))n++;else if(n||!r&&p){for(var s=!r&&p?t:0,f=i(e,(o-n-s)*a,n+s),l=0;s>l;l++)f.t.set(l,h());for(var l=0;n>l;l++)f.t.set(l+s,c.get(e,o-n+l)),c.set(e,o-n+l,0);r++}})}function s(){c.forEach(function(t,e){0==t&&A.set(e,A.get(e)+1)}),u.forEach(function(t,e){t.forEach(function(t){A.set(e,Math.max(0,A.get(e)-t.h))})}),o()}var f={grid:new binaryData.Grid(t,e,8,!1),size:a},c=f.grid,l=t,g=e;console.log(c);for(var u=[],v=0;l>v;v++)u.push([]);var m=[],d=1,M=0,b=[],y=b;y[1]=150,y[2]=y[1]+Math.floor(.4*l*g),y[3]=y[2]+Math.floor(.4*l*g)+l,y[4]=y[3]+Math.floor(.2*l*g),y[5]=y[4]+200,y[6]=y[5]+200,y[7]=y[6]+150,y[8]=y[7]+100,y[9]=y[8]+Math.floor(.4*l*g),y[10]=y[9]+Math.floor(.4*l*g),y[11]=y[10]+4*l,y[12]=y[11]+300;var p=!0,w=0;f.chains=u;var x=new binaryData.Grid(t,e,8,!1),A=new binaryData.Array(t,16,!1);return setInterval(function(){p&&s()},1e3),f.grid.forEachSet(function(){return h()}),f.draw=function(){var t=this.size;this.grid.forEach(function(e,a,i){e>1&&ctx.drawImage(tiles[e],a*t*ratio,i*t*ratio,t*ratio,t*ratio)}),u.forEach(function(e){e.forEach(function(e){e.t.forEach(function(a,i){a>1&&ctx.drawImage(tiles[a],e.x*t*ratio,(i*t+e.y)*ratio)})})}),ctx.save(),ctx.scale(ratio,ratio),ctx.fillStyle="#FFFFFF",ctx.strokeStyle="#223344",ctx.font="60pt Arial",ctx.lineWidth=4,ctx.strokeText(w,20,80),ctx.fillText(w,20,80),ctx.restore()},f.update=function(t){u.forEach(function(e){for(var i=0;i<e.length;i++){var n=e[i];n.v=Math.min(.5*a,n.v+.03125*a*t),n.y+=Math.min(.03125*n.v*t,.5*a),(c.get(n.x,Math.floor((n.y+n.h*a)/a))||n.y+n.h*a>=g*a)&&(n.t.forEach(function(t,e){t&&c.set(n.x,e+Math.floor(n.y/a),t)}),r(n),e.splice(i,1),i--)}})},f.click=function(t,e){if(t=Math.floor(t/a),e=Math.floor(e/a),l>t&&g>e){A.setAll(0);var i=c.get(t,e),r=0;x.setAll(0),i>1&&(propagate(c,t,e,function(t){return t==i},function(a,i){r++,2==r&&(c.set(t,e,0),A.set(t,A.get(t)+1),w++),r>=2&&(c.set(a,i,0),A.set(a,A.get(a)+1),w++)},x),o())}n()},f.usedChains=m,f.chains=u,f}