function makeNewPopperGame(t,e,a){function r(t,e,a){var r;return d.length>0?(r=d.pop(),r.t.forEachSet(function(){return 0}),r.x=t,r.y=e,r.h=a):r={x:t,y:e,t:new binaryData.Array(g,8,!1),h:a,v:0},v[t].push(r),r}function i(t){d.push(t)}function n(){for(;x>p[b+1]&&b<p.length-1;)switch(b++,b){case 1:w=!1;break;case 2:for(var t=0;u>t;t++){var e=r(t,-a,1);e.t.set(0,6)}for(var t=0;20*u>t;t++){var i=Math.random()*u*a;c.makeParticle(i,0,100*Math.random()+10,100*Math.random()+10,1e3*Math.random()+1e3,50,"white",5)}break;case 3:w=!0,M=2,s();break;case 4:M=3;break;case 5:M=4;break;case 6:M=5;break;case 7:M=6;break;case 8:w=!1;break;case 9:for(var t=0;u>t;t++){var e=r(t,-a,1);e.t.set(0,h())}break;case 10:M=1;for(var t=0;u>t;t++)for(var e=r(t,-3*a,3),n=0;3>n;n++)e.t.set(n,h());break;case 11:w=!0;break;case 12:alert("you have won the game at it's current state!")}}function h(){return 1==M?rand(4)+2:2==M?[2,4,5,6][rand(4)]:3==M?[2,4,4,4,4,5,6,6,6,6,6,6][rand(12)]:4==M?[2,4,4,4,4,4,6,6,6,6,6,6][rand(12)]:5==M?[2,2,2,4,5,4,3,5,6,4,6,6][rand(12)]:6==M?[2,3,4,5,6][rand(5)]:7==M?[2,3,4,5,6][rand(5)]:void 0}function o(){D.forEach(function(t,e){if(t)for(var i=0,n=0,o=0;g>o;o++)if(l.get(e,o))n++;else if(n||!i&&w){for(var s=!i&&w?t:0,f=r(e,(o-n-s)*a,n+s),c=0;s>c;c++)f.t.set(c,h());for(var c=0;n>c;c++)f.t.set(c+s,l.get(e,o-n+c)),l.set(e,o-n+c,0);i++}})}function s(){l.forEach(function(t,e){0==t&&D.set(e,D.get(e)+1)}),v.forEach(function(t,e){t.forEach(function(t){D.set(e,Math.max(0,D.get(e)-t.h))})}),o()}var f={grid:new binaryData.Grid(t,e,8,!1),size:a},c=createParticleSystem(),l=f.grid,u=t,g=e;console.log(l);for(var v=[],m=0;u>m;m++)v.push([]);var d=[],M=1,b=0,y=[],p=y;p[1]=150,p[2]=p[1]+Math.floor(.4*u*g),p[3]=p[2]+Math.floor(.4*u*g)+u,p[4]=p[3]+Math.floor(.2*u*g),p[5]=p[4]+200,p[6]=p[5]+200,p[7]=p[6]+150,p[8]=p[7]+100,p[9]=p[8]+Math.floor(.3*u*g),p[10]=p[9]+Math.floor(.3*u*g),p[11]=p[10]+3*u,p[12]=p[11]+300;var w=!0,x=0;f.chains=v;var A=new binaryData.Grid(t,e,8,!1),D=new binaryData.Array(t,16,!1);return setInterval(function(){w&&s()},1e3),f.grid.forEachSet(function(){return h()}),f.draw=function(){var t=this.size;this.grid.forEach(function(e,a,r){e>1&&ctx.drawImage(tiles[e],a*t*ratio,r*t*ratio,t*ratio,t*ratio)}),v.forEach(function(e){e.forEach(function(e){e.t.forEach(function(a,r){a>1&&ctx.drawImage(tiles[a],e.x*t*ratio,(r*t+e.y)*ratio)})})}),ctx.save(),ctx.scale(ratio,ratio),c.draw(ctx),ctx.restore()},f.update=function(t){v.forEach(function(e){for(var r=0;r<e.length;r++){var n=e[r];n.v=Math.min(.5*a,n.v+.03125*a*t),n.y+=Math.min(.03125*n.v*t,.5*a),(l.get(n.x,Math.floor((n.y+n.h*a)/a))||n.y+n.h*a>=g*a)&&(n.t.forEach(function(t,e){t&&l.set(n.x,e+Math.floor(n.y/a),t)}),i(n),e.splice(r,1),r--)}}),c.update(t)},f.click=function(t,e){if(t=Math.floor(t/a),e=Math.floor(e/a),u>t&&g>e){D.setAll(0);var r=l.get(t,e),i=0;A.setAll(0),r>1&&(propagate(l,t,e,function(t){return t==r},function(n,h){i++,2==i&&(l.set(t,e,0),D.set(t,D.get(t)+1),x++,c.burst(t*a,e*a,40,a,250,tileColors[r])),i>=2&&(l.set(n,h,0),D.set(n,D.get(n)+1),x++,c.burst(n*a,h*a,40,a,250,tileColors[r]))},A),o())}n()},f.usedChains=d,f.chains=v,f}