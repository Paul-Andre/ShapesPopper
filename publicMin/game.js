function makeNewPopperGame(t,i,e){function r(t,i,e){var r;return g.length>0?(r=g.pop(),r.t.forEachSet(function(){return 0}),r.x=t,r.y=i,r.h=e):r={x:t,y:i,t:new binaryData.Array(l,8,!1),h:e,v:0},c.push(r),r}function h(t){g.push(t)}function a(){return Math.floor(4*Math.random()+2)}function n(){d.forEach(function(t,i){if(t)for(var h=0,n=0,o=0;l>o;o++)if(s.get(i,o))n++;else if(n||!h&&u){for(var f=!h&&u?t:0,c=r(i,(o-n-f)*e,n+f),g=0;f>g;g++)c.t.set(g,a());for(var g=0;n>g;g++)c.t.set(g+f,s.get(i,o-n+g)),s.set(i,o-n+g,0);h++}})}var o={grid:new binaryData.Grid(t,i,8,!1),size:e},s=o.grid,f=t,l=i;console.log(s);var c=[],g=[],u=!0,m=0;o.chains=c;var v=new binaryData.Grid(t,i,8,!1),d=new binaryData.Array(t,16,!1);return o.grid.forEachSet(function(){return Math.floor(4*Math.random()+2)}),o.draw=function(){var t=this.size;this.grid.forEach(function(i,e,r){i>1&&ctx.drawImage(tiles[i],e*t*ratio,r*t*ratio,t*ratio,t*ratio)}),c.forEach(function(i){i.t.forEach(function(e,r){e>1&&ctx.drawImage(tiles[e],i.x*t*ratio,(r*t+i.y)*ratio)})}),ctx.save(),ctx.scale(ratio,ratio),ctx.fillStyle="#FFFFFF",ctx.strokeStyle="#223344",ctx.font="60pt Arial",ctx.lineWidth=4,ctx.strokeText(m,20,80),ctx.fillText(m,20,80),ctx.restore()},o.update=function(t){for(var i=0;i<c.length;i++){var r=c[i];r.v=Math.min(.5*e,r.v+.03125*e*t),r.y+=Math.min(.03125*r.v*t,.5*e),(s.get(r.x,Math.floor((r.y+r.h*e)/e))||r.y+r.h*e>=l*e)&&(r.t.forEach(function(t,i){t&&s.set(r.x,i+Math.floor(r.y/e),t)}),h(r),c.splice(i,1),i--)}},o.click=function(t,i){if(t=Math.floor(t/e),i=Math.floor(i/e),f>t&&l>i){d.setAll(0);var r=s.get(t,i),h=0;v.setAll(0),r>1&&(propagate(s,t,i,function(t){return t==r},function(e,r){h++,2==h&&(s.set(t,i,0),d.set(t,d.get(t)+1),m++),h>=2&&(s.set(e,r,0),d.set(e,d.get(e)+1),m++)},v),n())}m>100&&(u=!1)},o.usedChains=g,o.chains=c,o}