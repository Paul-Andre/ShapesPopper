function makeNewPopperGame(t,e,r){function a(t,e,r){var a;return b.length>0?(a=b.pop(),a.t.forEachSet(function(){return 0}),a.x=t,a.y=e,a.h=r):a={x:t,y:e,t:new binaryData.Array(d,8,!1),h:r,v:0},r>d&&(console.log(a),alert(r)),v[t].push(a),a}function i(t){b.push(t)}function n(){for(;I>w[p+1]&&p<w.length-1;)switch(p++,p){case 1:x=!1;break;case 2:for(var t=0;g>t;t++){var e=a(t,-r,1);e.t.set(0,6)}for(var t=0;20*g>t;t++){var i=Math.random()*g*r;c.makeParticle(i,0,100*Math.random()+10,100*Math.random()+10,1e3*Math.random()+1e3,50,"white",5,0)}break;case 3:x=!0,M=2,s();break;case 4:M=3;break;case 5:M=4;break;case 6:M=5;break;case 7:M=6;break;case 8:x=!1;break;case 9:for(var t=0;g>t;t++){var e=a(t,-r,1);e.t.set(0,h())}break;case 10:M=1;for(var t=0;g>t;t++)for(var e=a(t,-3*r,3),n=0;3>n;n++)e.t.set(n,h());break;case 11:x=!0;break;case 12:alert("you have won the game at it's current state!")}}function h(){return 1==M?rand(4)+2:2==M?[2,4,5,6][rand(4)]:3==M?[2,4,4,4,4,5,6,6,6,6,6,6][rand(12)]:4==M?[2,4,4,4,4,4,6,6,6,6,6,6][rand(12)]:5==M?[2,2,2,4,5,4,3,5,6,4,6,6][rand(12)]:6==M?[2,3,4,5,6][rand(5)]:7==M?[2,3,4,5,6][rand(5)]:void 0}function o(){A.forEach(function(t,e){if(t)for(var i=0,n=0,o=0;d>o;o++)if(u.get(e,o))n++;else if(n||!i&&x){for(var s=!i&&x?t:0,f=a(e,(o-n-s)*r,n+s),l=0;s>l;l++)f.t.set(l,h());for(var l=0;n>l;l++)f.t.set(l+s,u.get(e,o-n+l)),u.set(e,o-n+l,0);i++}})}function s(){A.setAll(0),u.forEach(function(t,e){0==t&&A.set(e,A.get(e)+1)}),v.forEach(function(t,e){t.forEach(function(t){A.set(e,Math.max(0,A.get(e)-t.h))})}),o()}function f(t,e){return t>=powerIndex&&(t=t-powerIndex+baseIndex),e>=powerIndex&&(e=e-powerIndex+baseIndex),t==e}var l={grid:new binaryData.Grid(t,e,8,!1),size:r,width:t,height:e,chains:[],overlays:[]},c=createParticleSystem();l.pS=c;var u=l.grid,g=t,d=e;console.log(u);for(var v=l.chains,m=0;g>m;m++)v.push([]);var b=[],M=1,p=0,y=[],w=y;w[1]=150,w[2]=w[1]+Math.floor(.4*g*d),w[3]=w[2]+Math.floor(.4*g*d)+g,w[4]=w[3]+Math.floor(.2*g*d),w[5]=w[4]+200,w[6]=w[5]+200,w[7]=w[6]+150,w[8]=w[7]+100,w[9]=w[8]+Math.floor(.3*g*d),w[10]=w[9]+Math.floor(.3*g*d),w[11]=w[10]+3*g,w[12]=w[11]+300;var x=!0,I=0;l.chains=v;var D=new binaryData.Grid(t,e,8,!1),A=new binaryData.Array(t,16,!1);return l.modifiedClumns=A,l.fill=s,setInterval(function(){x&&s()},1e3),l.grid.forEachSet(function(){return h()}),l.grid.set(5,5,16),l.grid.set(12,10,17),l.draw=function(){var t=this.size;this.grid.forEach(function(e,r,a){e>1&&ctx.drawImage(tiles[e],r*t*ratio,a*t*ratio,t*ratio,t*ratio)}),v.forEach(function(e){e.forEach(function(e){e.t.forEach(function(r,a){r>1&&ctx.drawImage(tiles[r],e.x*t*ratio,(a*t+e.y)*ratio)})})}),ctx.save(),ctx.scale(ratio,ratio),this.overlays.forEach(function(t){t.draw(ctx)}),c.draw(ctx),ctx.restore()},l.update=function(t){v.forEach(function(e){for(var a=0;a<e.length;a++){var n=e[a];n.v=Math.min(.5*r,n.v+.03125*r*t),n.y+=Math.min(.03125*n.v*t,.5*r),(u.get(n.x,Math.floor((n.y+n.h*r)/r))||n.y+n.h*r>=d*r)&&(n.t.forEach(function(t,e){t&&u.set(n.x,e+Math.floor(n.y/r),t)}),i(n),e.splice(a,1),a--)}});for(var e=0;e<this.overlays.length;e++)this.overlays[e].update(t)&&(this.overlays.splice(e,1),e--);c.update(t)},l.click=function(t,e){var a=[];if(t=Math.floor(t/r),e=Math.floor(e/r),g>t&&d>e){var i=u.get(t,e),h=0;D.setAll(0),i>=baseIndex&&(propagate(u,t,e,function(t){return f(t,i)},function(n,o){function s(t,e){u.get(t,e)>=powerIndex?a.push({x:t,y:e,f:u.get(t,e)-powerIndex}):c.burst(t*r,e*r,40,r,2e3,particleColors[i]),u.set(t,e,0),I++}h++,2==h&&s(t,e),h>=2&&s(n,o)},D),a.forEach(function(t){specials[t.f](l,t.x,t.y)}),s())}n()},l.usedChains=b,l.chains=v,l}