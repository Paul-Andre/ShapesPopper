function makeNewPopperGame(t,e,i){function a(t,e,i){var a;return d.length>0?(a=d.pop(),a.t.forEachSet(function(){return 0}),a.x=t,a.y=e,a.h=i):a={x:t,y:e,t:new binaryData.Array(g,8,!1),h:i,v:0},u[t].push(a),a}function r(t){d.push(t)}function n(){if(w>y[M+1]&&M<y.length-1){for(;w>y[M+1]&&M<y.length-1;)M++;switch(M){case 1:p=!1;break;case 2:for(var t=0;l>t;t++){var e=a(t,-i+1,1);e.t.set(0,6)}break;case 3:p=!0,m=2,s();break;case 4:m=3;break;case 5:m=4;break;case 6:m=5;break;case 7:m=6;break;case 8:p=!1;break;case 9:for(var t=0;l>t;t++){var e=a(t,-i+1,1);e.t.set(0,h)}break;case 10:m=1;for(var t=0;l>t;t++)for(var r=0;3>r;r++){var e=a(t,-i+1,1);e.t.set(r,h)}break;case 11:p=!0}}}function h(){return 1==m?rand(4)+2:2==m?[2,4,5,6][rand(4)]:3==m?[2,4,4,4,4,5,6,6,6,6,6,6][rand(12)]:4==m?[2,4,4,4,4,4,6,6,6,6,6,6][rand(12)]:5==m?[2,2,2,4,5,4,3,5,6,4,6,6][rand(12)]:6==m?[2,3,4,5,6][rand(5)]:7==m?[2,3,4,5,6][rand(5)]:void 0}function o(){A.forEach(function(t,e){if(t)for(var r=0,n=0,o=0;g>o;o++)if(c.get(e,o))n++;else if(n||!r&&p){for(var s=!r&&p?t:0,f=a(e,(o-n-s)*i,n+s),l=0;s>l;l++)f.t.set(l,h());for(var l=0;n>l;l++)f.t.set(l+s,c.get(e,o-n+l)),c.set(e,o-n+l,0);r++}})}function s(){c.forEach(function(t,e){0==t&&A.set(e,A.get(e)+1)}),u.forEach(function(t,e){t.forEach(function(t){A.set(e,Math.max(0,A.get(e)-t.h))})}),o()}var f={grid:new binaryData.Grid(t,e,8,!1),size:i},c=f.grid,l=t,g=e;console.log(c);for(var u=[],v=0;l>v;v++)u.push([]);var d=[],m=1,M=0,b=[],y=b;y[1]=150,y[2]=y[1]+Math.floor(.4*l*g),y[3]=y[2]+Math.floor(.4*l*g)+l,y[4]=y[3]+Math.floor(.2*l*g),y[5]=y[4]+Math.floor(2*l*g),y[6]=y[5]+Math.floor(2*l*g),y[7]=y[6]+Math.floor(2*l*g),y[8]=y[7]+Math.floor(.9*l*g),y[9]=y[8]+Math.floor(.5*l*g),y[10]=y[9]+l,y[11]=y[10]+4*l,y[12]=y[11]+Math.floor(1*l*g);var p=!0,w=0;f.chains=u;var x=new binaryData.Grid(t,e,8,!1),A=new binaryData.Array(t,16,!1);return setInterval(function(){p&&s()},1e3),f.grid.forEachSet(function(){return h()}),f.draw=function(){var t=this.size;this.grid.forEach(function(e,i,a){e>1&&ctx.drawImage(tiles[e],i*t*ratio,a*t*ratio,t*ratio,t*ratio)}),u.forEach(function(e){e.forEach(function(e){e.t.forEach(function(i,a){i>1&&ctx.drawImage(tiles[i],e.x*t*ratio,(a*t+e.y)*ratio)})})}),ctx.save(),ctx.scale(ratio,ratio),ctx.fillStyle="#FFFFFF",ctx.strokeStyle="#223344",ctx.font="60pt Arial",ctx.lineWidth=4,ctx.strokeText(w,20,80),ctx.fillText(w,20,80),ctx.restore()},f.update=function(t){u.forEach(function(e){for(var a=0;a<e.length;a++){var n=e[a];n.v=Math.min(.5*i,n.v+.03125*i*t),n.y+=Math.min(.03125*n.v*t,.5*i),(c.get(n.x,Math.floor((n.y+n.h*i)/i))||n.y+n.h*i>=g*i)&&(n.t.forEach(function(t,e){t&&c.set(n.x,e+Math.floor(n.y/i),t)}),r(n),e.splice(a,1),a--)}})},f.click=function(t,e){if(t=Math.floor(t/i),e=Math.floor(e/i),l>t&&g>e){A.setAll(0);var a=c.get(t,e),r=0;x.setAll(0),a>1&&(propagate(c,t,e,function(t){return t==a},function(i,a){r++,2==r&&(c.set(t,e,0),A.set(t,A.get(t)+1),w++),r>=2&&(c.set(i,a,0),A.set(i,A.get(i)+1),w++)},x),o())}n()},f.usedChains=d,f.chains=u,f}